<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reezo Moderation Miniapp</title>
  <style>
    :root {
      --bg: #070d18;
      --panel: #101c33;
      --panel2: #0d1730;
      --text: #f2f7ff;
      --muted: #9cb2d7;
      --line: #2f436c;
      --accent: #2f8cff;
      --accent2: #4ab274;
      --danger: #e46464;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      background: radial-gradient(circle at top, #1a2f57 0%, var(--bg) 45%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    main { max-width: 760px; margin: 0 auto; padding: 14px 14px 28px; }
    .header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .title { margin: 0; font-size: 22px; }
    .muted { color: var(--muted); margin: 6px 0 0; font-size: 13px; }
    .card {
      margin-top: 12px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .row > * { flex: 1 1 180px; }
    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 4px; }
    input, textarea, select, button {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0b1730;
      color: var(--text);
      padding: 10px 11px;
      font-size: 14px;
    }
    button { cursor: pointer; background: #17325b; font-weight: 700; }
    .btn-accent { background: linear-gradient(90deg, #2a7bea, #3a9dff); border-color: #4d97ff; }
    .btn-ok { background: linear-gradient(90deg, #2a8d5e, #49b67f); border-color: #66c796; }
    .btn-ghost { background: #102449; }
    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      background: #102043;
      margin-right: 6px;
    }
    .seg { display: flex; gap: 8px; }
    .seg button.active { border-color: #7fb4ff; background: #245197; }
    .status { min-height: 18px; margin-top: 8px; font-size: 13px; white-space: pre-wrap; }
    .status.ok { color: #8fe3b8; }
    .status.err { color: #ff9b9b; }
    ul { margin: 8px 0 0; padding-left: 18px; }
    li { margin: 4px 0; color: #d7e5ff; }
    .hidden { display: none; }
    .profiles-box { margin-top: 10px; border: 1px solid var(--line); border-radius: 10px; padding: 10px; background: #0a1530; }
    .profiles-tab { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    .profiles-tab button { flex: 1 1 100px; }
    .profile-card { border: 1px solid #2f4f84; border-radius: 10px; padding: 10px; }
    .checkbox-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; margin-top: 10px; }
    .check-item { display: flex; gap: 8px; align-items: center; padding: 8px; border: 1px solid #2e4675; border-radius: 10px; background: #0c1b38; }
    .check-item input { width: 16px; height: 16px; }
    .summary-box { margin-top: 10px; padding: 8px; border: 1px dashed #4869a7; border-radius: 10px; font-size: 12px; color: #c8dcff; white-space: pre-wrap; }
    .rule-row { display: grid; grid-template-columns: 1.3fr 1fr auto; gap: 8px; margin-top: 8px; }
    .rule-del { width: auto; padding: 10px 12px; border-color: #74516c; background: #2f1d2f; }
  </style>
</head>
<body>
  <main>
    <div class="header">
      <div>
        <h1 class="title">Moderation</h1>
        <p class="muted" id="subtitle">Manage groups/channels</p>
      </div>
      <button id="btnBack" class="btn-ghost" type="button">Back</button>
    </div>

    <section id="menuView" class="card hidden">
      <div class="row">
        <button id="goAdd" class="btn-accent" type="button">Add New Group/Channel</button>
        <button id="goSettings" class="btn-ok" type="button">Group/Channel Setting</button>
      </div>
    </section>

    <section id="addView" class="card hidden">
      <p class="muted">Tambah target baru untuk moderation.</p>
      <div class="seg" style="margin-bottom:10px;">
        <button id="typeGroup" type="button" class="active">Group</button>
        <button id="typeChannel" type="button">Channel</button>
      </div>
      <div class="row">
        <div>
          <label for="targetId">Group/Channel ID</label>
          <input id="targetId" type="text" placeholder="-1001234567890" />
        </div>
        <div>
          <label for="targetName">Group/Channel Name</label>
          <input id="targetName" type="text" placeholder="NEXT Main Group" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="submitAdd" class="btn-accent" type="button">Submit</button>
      </div>
      <p id="addStatus" class="status"></p>
      <div style="margin-top:8px;">
        <span class="pill">Saved list</span>
        <ul id="savedList"></ul>
      </div>
    </section>

    <section id="settingsView" class="card hidden">
      <p class="muted">Pilih target ikut tab dan ubah setting.</p>
      <div class="seg" style="margin-bottom:10px;">
        <button id="tabGroup" type="button" class="active">Group</button>
        <button id="tabChannel" type="button">Channel</button>
      </div>

      <label for="targetSelect">Select target</label>
      <select id="targetSelect"></select>

      <div id="settingsFields" style="margin-top:10px;">
        <div id="groupSettingsPanel" class="hidden">
          <div class="profiles-box">
            <div class="profiles-tab">
              <button id="profileTab1" type="button" class="active">Profile 1</button>
              <button id="profileTab2" type="button">Profile 2</button>
              <button id="profileTab3" type="button">Profile 3</button>
              <button id="profileTab4" type="button">Profile 4</button>
            </div>

            <div class="profile-card">
              <div class="row">
                <div>
                  <label for="triggerLinkMode">Trigger Link</label>
                  <select id="triggerLinkMode">
                    <option value="all_links">All links</option>
                    <option value="specific_prefix">Specific URL prefix</option>
                  </select>
                </div>
                <div>
                  <label for="triggerLinkPrefix">Specific URL prefix</label>
                  <input id="triggerLinkPrefix" type="text" placeholder="https://t.me/" />
                </div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div>
                  <label for="linkAction">Link Action</label>
                  <select id="linkAction">
                    <option value="delete">delete</option>
                    <option value="delete_and_ban">delete & ban</option>
                    <option value="delete_plus_one_chance">delete + 1 chance</option>
                  </select>
                </div>
                <div>
                  <label>Trigger Comment Rules</label>
                  <button id="addCommentRule" type="button" class="btn-ghost">+ tambah trigger</button>
                </div>
              </div>
              <div id="commentRulesList"></div>
              <div class="row" style="margin-top:8px;">
                <div>
                  <label for="disableCommentsEnabled">Disable Comment</label>
                  <select id="disableCommentsEnabled">
                    <option value="false">off</option>
                    <option value="true">on</option>
                  </select>
                </div>
                <div>
                  <label for="bgToggleMode">BG Toggle</label>
                  <select id="bgToggleMode">
                    <option value="6h">6 jam</option>
                    <option value="12h">12 jam</option>
                    <option value="24h">24 jam</option>
                    <option value="custom">custom</option>
                  </select>
                  <input id="bgToggleCustomHours" type="number" min="1" max="720" value="6" style="margin-top:8px;" placeholder="custom jam" />
                </div>
              </div>
            </div>

            <div style="margin-top:10px;">
              <label>Active Profile (boleh pilih lebih dari satu)</label>
              <div class="checkbox-grid">
                <label class="check-item"><input type="checkbox" id="activeP1" /> Profile 1</label>
                <label class="check-item"><input type="checkbox" id="activeP2" /> Profile 2</label>
                <label class="check-item"><input type="checkbox" id="activeP3" /> Profile 3</label>
                <label class="check-item"><input type="checkbox" id="activeP4" /> Profile 4</label>
              </div>
            </div>

            <div id="groupSummary" class="summary-box"></div>
          </div>
        </div>

        <div id="channelSettingsPanel" class="hidden">
          <div class="row">
            <div>
              <label for="discussionGroupIdInput">Discussion Group ID</label>
              <input id="discussionGroupIdInput" type="text" placeholder="-1001234567890" />
            </div>
            <div>
              <label for="commentsOnPostsEnabled">Comment on post</label>
              <select id="commentsOnPostsEnabled">
                <option value="true">on</option>
                <option value="false">off</option>
              </select>
            </div>
          </div>
          <div class="profiles-box" style="margin-top:10px;">
            <div class="row">
              <div>
                <label>Broadcast Preset</label>
                <button id="addBroadcastPreset" type="button" class="btn-ghost">+ tambah preset</button>
              </div>
            </div>
            <div id="broadcastPresetList"></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="submitSetting" class="btn-ok" type="button">Save Setting</button>
        </div>
      </div>

      <p id="settingsStatus" class="status"></p>
    </section>
  </main>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand();
    }

    const qs = new URLSearchParams(window.location.search);
    let view = (qs.get("view") || "menu").trim();

    function decodeState(raw) {
      if (!raw) return { targets: [], target_settings: {} };
      try {
        const padded = raw + "=".repeat((4 - (raw.length % 4)) % 4);
        const bin = atob(padded.replace(/-/g, "+").replace(/_/g, "/"));
        const utf8 = decodeURIComponent(Array.from(bin).map((c) => "%" + c.charCodeAt(0).toString(16).padStart(2, "0")).join(""));
        const parsed = JSON.parse(utf8);
        return {
          targets: Array.isArray(parsed.targets) ? parsed.targets : [],
          target_settings: parsed && typeof parsed.target_settings === "object" && parsed.target_settings ? parsed.target_settings : {}
        };
      } catch (_) {
        return { targets: [], target_settings: {} };
      }
    }

    const state = decodeState(qs.get("state"));
    let addType = "group";
    let settingsTab = "group";
    let activeProfileTab = 1;

    const menuView = document.getElementById("menuView");
    const addView = document.getElementById("addView");
    const settingsView = document.getElementById("settingsView");
    const subtitle = document.getElementById("subtitle");

    function sendPayload(payload) {
      if (!tg) return;
      tg.sendData(JSON.stringify(payload));
    }

    function setStatus(el, text, ok) {
      el.textContent = text;
      el.className = "status " + (ok ? "ok" : "err");
    }

    function switchView(next) {
      view = next;
      menuView.classList.add("hidden");
      addView.classList.add("hidden");
      settingsView.classList.add("hidden");
      if (next === "add") {
        subtitle.textContent = "Add new group/channel";
        addView.classList.remove("hidden");
        renderSavedList();
      } else if (next === "settings") {
        subtitle.textContent = "Group/channel setting";
        settingsView.classList.remove("hidden");
        renderTargetSelect();
      } else {
        subtitle.textContent = "Manage groups/channels";
        menuView.classList.remove("hidden");
      }
    }

    function typeButtonStyle() {
      document.getElementById("typeGroup").classList.toggle("active", addType === "group");
      document.getElementById("typeChannel").classList.toggle("active", addType === "channel");
    }

    function tabButtonStyle() {
      document.getElementById("tabGroup").classList.toggle("active", settingsTab === "group");
      document.getElementById("tabChannel").classList.toggle("active", settingsTab === "channel");
      document.getElementById("groupSettingsPanel").classList.toggle("hidden", settingsTab !== "group");
      document.getElementById("channelSettingsPanel").classList.toggle("hidden", settingsTab !== "channel");
    }

    function profileTabStyle() {
      [1, 2, 3, 4].forEach((id) => {
        document.getElementById("profileTab" + id).classList.toggle("active", activeProfileTab === id);
      });
    }

    function ensureGroupProfiles() {
      if (!state.group_profile_draft) {
        state.group_profile_draft = {
          profiles: [1, 2, 3, 4].map(() => ({
            trigger_link_mode: "all_links",
            trigger_link_prefix: "",
            link_action: "delete",
            trigger_comment_rules: [{ text: "", action: "delete" }],
            disable_comments_enabled: false,
            bg_toggle_mode: "6h",
            bg_toggle_custom_hours: 6
          })),
          enabled_profile_ids: [1]
        };
      }
    }

    function renderSavedList() {
      const ul = document.getElementById("savedList");
      ul.innerHTML = "";
      if (!state.targets.length) {
        const li = document.createElement("li");
        li.textContent = "No target yet.";
        ul.appendChild(li);
        return;
      }
      state.targets.forEach((t) => {
        const li = document.createElement("li");
        li.textContent = `[${String(t.type || "").toUpperCase()}] ${t.name || t.id} (${t.id})`;
        ul.appendChild(li);
      });
    }

    function ensureChannelDraft() {
      if (!state.channel_draft) {
        state.channel_draft = {
          discussion_group_id: "",
          comments_on_posts_enabled: true,
          broadcast_presets: [{ name: "Preset 1", text: "" }]
        };
      }
      if (!Array.isArray(state.channel_draft.broadcast_presets)) {
        state.channel_draft.broadcast_presets = [{ name: "Preset 1", text: "" }];
      }
      if (!state.channel_draft.broadcast_presets.length) {
        state.channel_draft.broadcast_presets.push({ name: "Preset 1", text: "" });
      }
    }

    function loadDraftFromTarget(targetId) {
      ensureGroupProfiles();
      const saved = state.target_settings && state.target_settings[targetId] ? state.target_settings[targetId] : {};
      if (!saved || typeof saved !== "object") return;

      if (Array.isArray(saved.group_profiles) && saved.group_profiles.length === 4) {
        state.group_profile_draft.profiles = saved.group_profiles.map((p) => ({
          trigger_link_mode: p.trigger_link_mode === "specific_prefix" ? "specific_prefix" : "all_links",
          trigger_link_prefix: String(p.trigger_link_prefix || ""),
          link_action: ["delete", "delete_and_ban", "delete_plus_one_chance"].includes(p.link_action) ? p.link_action : "delete",
          trigger_comment_rules: Array.isArray(p.trigger_comment_rules) && p.trigger_comment_rules.length
            ? p.trigger_comment_rules.map((r) => ({
                text: String(r.text || "").trim(),
                action: ["delete", "delete_and_ban", "delete_plus_one_chance"].includes(r.action) ? r.action : "delete"
              }))
            : [{ text: "", action: "delete" }],
          disable_comments_enabled: !!p.disable_comments_enabled,
          bg_toggle_mode: ["6h", "12h", "24h", "custom"].includes(p.bg_toggle_mode) ? p.bg_toggle_mode : "6h",
          bg_toggle_custom_hours: Number.isFinite(Number(p.bg_toggle_custom_hours)) ? Math.max(1, Number(p.bg_toggle_custom_hours)) : 6
        }));
      }
      if (Array.isArray(saved.enabled_profile_ids) && saved.enabled_profile_ids.length) {
        const ids = saved.enabled_profile_ids.map((x) => Number(x)).filter((x) => [1,2,3,4].includes(x));
        state.group_profile_draft.enabled_profile_ids = ids.length ? Array.from(new Set(ids)) : [1];
      }

      ensureChannelDraft();
      state.channel_draft.discussion_group_id = String(saved.discussion_group_id || "");
      state.channel_draft.comments_on_posts_enabled = saved.comments_on_posts_enabled !== false;
      state.channel_draft.broadcast_presets = Array.isArray(saved.broadcast_presets) && saved.broadcast_presets.length
        ? saved.broadcast_presets.map((p) => ({ name: String(p.name || "").trim(), text: String(p.text || "") }))
        : [{ name: "Preset 1", text: "" }];
      document.getElementById("discussionGroupIdInput").value = state.channel_draft.discussion_group_id;
      document.getElementById("commentsOnPostsEnabled").value = state.channel_draft.comments_on_posts_enabled ? "true" : "false";
      renderBroadcastPresets();
    }

    function fillCurrentSetting() {
      const select = document.getElementById("targetSelect");
      const targetId = select.value;
      if (!targetId) return;
      loadDraftFromTarget(targetId);
      if (settingsTab === "group") {
        renderGroupProfileUI();
      } else {
        ensureChannelDraft();
        document.getElementById("discussionGroupIdInput").value = state.channel_draft.discussion_group_id || "";
        document.getElementById("commentsOnPostsEnabled").value = state.channel_draft.comments_on_posts_enabled ? "true" : "false";
        renderBroadcastPresets();
      }
    }

    function renderTargetSelect() {
      const select = document.getElementById("targetSelect");
      select.innerHTML = "";
      const filtered = state.targets.filter((x) => String(x.type) === settingsTab);
      if (!filtered.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = `No ${settingsTab} target`;
        select.appendChild(opt);
        document.getElementById("settingsFields").style.opacity = "0.5";
        document.getElementById("settingsFields").style.pointerEvents = "none";
        setStatus(document.getElementById("settingsStatus"), `Tambah ${settingsTab} dulu dalam Add New Group/Channel.`, false);
        return;
      }
      document.getElementById("settingsFields").style.opacity = "1";
      document.getElementById("settingsFields").style.pointerEvents = "auto";
      document.getElementById("settingsStatus").textContent = "";
      filtered.forEach((t) => {
        const opt = document.createElement("option");
        opt.value = String(t.id);
        opt.textContent = `${t.name || t.id} (${t.id})`;
        select.appendChild(opt);
      });
      fillCurrentSetting();
    }

    function persistProfileDraft() {
      ensureGroupProfiles();
      const p = state.group_profile_draft.profiles[activeProfileTab - 1];
      p.trigger_link_mode = document.getElementById("triggerLinkMode").value;
      p.trigger_link_prefix = document.getElementById("triggerLinkPrefix").value.trim();
      p.link_action = document.getElementById("linkAction").value;
      p.trigger_comment_rules = collectCommentRulesFromUI();
      p.disable_comments_enabled = document.getElementById("disableCommentsEnabled").value === "true";
      p.bg_toggle_mode = document.getElementById("bgToggleMode").value;
      p.bg_toggle_custom_hours = Math.max(1, Number(document.getElementById("bgToggleCustomHours").value || 6));

      const enabled = [];
      if (document.getElementById("activeP1").checked) enabled.push(1);
      if (document.getElementById("activeP2").checked) enabled.push(2);
      if (document.getElementById("activeP3").checked) enabled.push(3);
      if (document.getElementById("activeP4").checked) enabled.push(4);
      state.group_profile_draft.enabled_profile_ids = enabled;
    }

    function renderGroupSummary() {
      ensureGroupProfiles();
      const active = state.group_profile_draft.enabled_profile_ids;
      const lines = [];
      lines.push("Enabled profile: " + (active.length ? active.join(", ") : "none"));
      active.forEach((id) => {
        const p = state.group_profile_draft.profiles[id - 1];
        const linkRule = p.trigger_link_mode === "all_links" ? "all links" : ("prefix=" + (p.trigger_link_prefix || "(empty)"));
        const bgRule = p.bg_toggle_mode === "custom" ? ("custom " + p.bg_toggle_custom_hours + "h") : p.bg_toggle_mode;
        const comments = (Array.isArray(p.trigger_comment_rules) ? p.trigger_comment_rules : [])
          .filter((r) => r && r.text)
          .map((r) => `${r.text}:${r.action}`)
          .join(", ");
        lines.push("P" + id + ": " + linkRule + " | link_action=" + p.link_action + " | comments=" + (comments || "-") + " | disable_comment=" + (p.disable_comments_enabled ? "on" : "off") + " | bg=" + bgRule);
      });
      document.getElementById("groupSummary").textContent = lines.join("\n");
    }

    function renderCommentRules() {
      const list = document.getElementById("commentRulesList");
      const p = state.group_profile_draft.profiles[activeProfileTab - 1];
      const rules = Array.isArray(p.trigger_comment_rules) && p.trigger_comment_rules.length
        ? p.trigger_comment_rules
        : [{ text: "", action: "delete" }];
      p.trigger_comment_rules = rules;
      list.innerHTML = "";
      rules.forEach((rule, idx) => {
        const row = document.createElement("div");
        row.className = "rule-row";
        row.innerHTML =
          `<input data-rule-text=\"${idx}\" type=\"text\" placeholder=\"contoh: join now\" value=\"${String(rule.text || "").replace(/\"/g, "&quot;")}\" />` +
          `<select data-rule-action=\"${idx}\">` +
            `<option value=\"delete\" ${rule.action === "delete" ? "selected" : ""}>delete</option>` +
            `<option value=\"delete_and_ban\" ${rule.action === "delete_and_ban" ? "selected" : ""}>delete & ban</option>` +
            `<option value=\"delete_plus_one_chance\" ${rule.action === "delete_plus_one_chance" ? "selected" : ""}>delete + 1 chance</option>` +
          `</select>` +
          `<button class=\"rule-del\" type=\"button\" data-rule-del=\"${idx}\">buang</button>`;
        list.appendChild(row);
      });
    }

    function collectCommentRulesFromUI() {
      const rows = [];
      const textNodes = Array.from(document.querySelectorAll("#commentRulesList [data-rule-text]"));
      textNodes.forEach((node) => {
        const idx = node.getAttribute("data-rule-text");
        const actionNode = document.querySelector(`#commentRulesList [data-rule-action="${idx}"]`);
        const text = String(node.value || "").trim();
        const action = actionNode ? actionNode.value : "delete";
        if (!text) return;
        rows.push({
          text,
          action: ["delete", "delete_and_ban", "delete_plus_one_chance"].includes(action) ? action : "delete"
        });
      });
      return rows.length ? rows : [{ text: "", action: "delete" }];
    }

    function renderGroupProfileUI() {
      ensureGroupProfiles();
      const p = state.group_profile_draft.profiles[activeProfileTab - 1];
      document.getElementById("triggerLinkMode").value = p.trigger_link_mode;
      document.getElementById("triggerLinkPrefix").value = p.trigger_link_prefix;
      document.getElementById("linkAction").value = p.link_action;
      document.getElementById("disableCommentsEnabled").value = p.disable_comments_enabled ? "true" : "false";
      document.getElementById("bgToggleMode").value = p.bg_toggle_mode;
      document.getElementById("bgToggleCustomHours").value = String(p.bg_toggle_custom_hours || 6);

      document.getElementById("activeP1").checked = state.group_profile_draft.enabled_profile_ids.includes(1);
      document.getElementById("activeP2").checked = state.group_profile_draft.enabled_profile_ids.includes(2);
      document.getElementById("activeP3").checked = state.group_profile_draft.enabled_profile_ids.includes(3);
      document.getElementById("activeP4").checked = state.group_profile_draft.enabled_profile_ids.includes(4);

      profileTabStyle();
      renderCommentRules();
      renderGroupSummary();
    }

    function collectBroadcastPresetsFromUI() {
      const rows = [];
      const nameNodes = Array.from(document.querySelectorAll("#broadcastPresetList [data-preset-name]"));
      nameNodes.forEach((node) => {
        const idx = node.getAttribute("data-preset-name");
        const textNode = document.querySelector(`#broadcastPresetList [data-preset-text="${idx}"]`);
        const name = String(node.value || "").trim();
        const text = textNode ? String(textNode.value || "").trim() : "";
        if (!name || !text) return;
        rows.push({ name, text });
      });
      return rows;
    }

    function renderBroadcastPresets() {
      ensureChannelDraft();
      const box = document.getElementById("broadcastPresetList");
      box.innerHTML = "";
      state.channel_draft.broadcast_presets.forEach((preset, idx) => {
        const row = document.createElement("div");
        row.className = "rule-row";
        row.innerHTML =
          `<input data-preset-name="${idx}" type="text" placeholder="Preset name" value="${String(preset.name || "").replace(/\"/g, "&quot;")}" />` +
          `<input data-preset-text="${idx}" type="text" placeholder="Broadcast text" value="${String(preset.text || "").replace(/\"/g, "&quot;")}" />` +
          `<button class="rule-del" type="button" data-preset-del="${idx}">buang</button>`;
        box.appendChild(row);
      });
    }

    function persistChannelDraft() {
      ensureChannelDraft();
      state.channel_draft.discussion_group_id = String(document.getElementById("discussionGroupIdInput").value || "").trim();
      state.channel_draft.comments_on_posts_enabled = document.getElementById("commentsOnPostsEnabled").value === "true";
      state.channel_draft.broadcast_presets = collectBroadcastPresetsFromUI();
      if (!state.channel_draft.broadcast_presets.length) {
        state.channel_draft.broadcast_presets = [{ name: "Preset 1", text: "" }];
      }
    }

    document.getElementById("btnBack").addEventListener("click", () => {
      if (view === "menu") {
        sendPayload({ type: "reezo_moderator_back_to_menu" });
        if (tg) tg.close();
        return;
      }
      switchView("menu");
    });

    document.getElementById("goAdd").addEventListener("click", () => switchView("add"));
    document.getElementById("goSettings").addEventListener("click", () => switchView("settings"));

    document.getElementById("typeGroup").addEventListener("click", () => { addType = "group"; typeButtonStyle(); });
    document.getElementById("typeChannel").addEventListener("click", () => { addType = "channel"; typeButtonStyle(); });

    document.getElementById("submitAdd").addEventListener("click", () => {
      const idRaw = document.getElementById("targetId").value.trim();
      const name = document.getElementById("targetName").value.trim();
      const status = document.getElementById("addStatus");
      if (!/^\-\d+$/.test(idRaw)) {
        setStatus(status, "ID mesti nombor negatif. Contoh: -1001234567890", false);
        return;
      }
      if (!name) {
        setStatus(status, "Nama group/channel wajib isi.", false);
        return;
      }
      const targetId = Number(idRaw);
      if (!Number.isSafeInteger(targetId)) {
        setStatus(status, "ID terlalu besar/tak sah.", false);
        return;
      }
      const existing = state.targets.find((t) => Number(t.id) === targetId);
      if (existing) {
        existing.type = addType;
        existing.name = name;
      } else {
        state.targets.push({ type: addType, id: targetId, name });
      }
      renderSavedList();
      sendPayload({
        type: "reezo_moderator_target_add",
        target_type: addType,
        target_id: targetId,
        target_name: name
      });
      setStatus(status, "Submitted. Target saved in list.", true);
      document.getElementById("targetId").value = "";
      document.getElementById("targetName").value = "";
    });

    document.getElementById("tabGroup").addEventListener("click", () => {
      settingsTab = "group";
      tabButtonStyle();
      renderTargetSelect();
    });
    document.getElementById("tabChannel").addEventListener("click", () => {
      settingsTab = "channel";
      tabButtonStyle();
      renderTargetSelect();
    });

    document.getElementById("targetSelect").addEventListener("change", fillCurrentSetting);

    [1,2,3,4].forEach((id) => {
      document.getElementById("profileTab" + id).addEventListener("click", () => {
        persistProfileDraft();
        activeProfileTab = id;
        renderGroupProfileUI();
      });
    });

    ["triggerLinkMode", "triggerLinkPrefix", "linkAction", "disableCommentsEnabled", "bgToggleMode", "bgToggleCustomHours", "activeP1", "activeP2", "activeP3", "activeP4"].forEach((id) => {
      document.getElementById(id).addEventListener("change", () => {
        persistProfileDraft();
        renderGroupSummary();
      });
    });

    document.getElementById("addCommentRule").addEventListener("click", () => {
      ensureGroupProfiles();
      persistProfileDraft();
      const p = state.group_profile_draft.profiles[activeProfileTab - 1];
      p.trigger_comment_rules.push({ text: "", action: "delete" });
      renderCommentRules();
    });

    document.getElementById("commentRulesList").addEventListener("click", (ev) => {
      const btn = ev.target.closest("[data-rule-del]");
      if (!btn) return;
      ensureGroupProfiles();
      persistProfileDraft();
      const idx = Number(btn.getAttribute("data-rule-del"));
      const p = state.group_profile_draft.profiles[activeProfileTab - 1];
      if (!Number.isInteger(idx) || idx < 0 || idx >= p.trigger_comment_rules.length) return;
      p.trigger_comment_rules.splice(idx, 1);
      if (!p.trigger_comment_rules.length) p.trigger_comment_rules.push({ text: "", action: "delete" });
      renderCommentRules();
      renderGroupSummary();
    });

    document.getElementById("commentRulesList").addEventListener("change", () => {
      persistProfileDraft();
      renderGroupSummary();
    });

    document.getElementById("addBroadcastPreset").addEventListener("click", () => {
      ensureChannelDraft();
      persistChannelDraft();
      const nextIdx = state.channel_draft.broadcast_presets.length + 1;
      state.channel_draft.broadcast_presets.push({ name: "Preset " + nextIdx, text: "" });
      renderBroadcastPresets();
    });

    document.getElementById("broadcastPresetList").addEventListener("click", (ev) => {
      const btn = ev.target.closest("[data-preset-del]");
      if (!btn) return;
      ensureChannelDraft();
      persistChannelDraft();
      const idx = Number(btn.getAttribute("data-preset-del"));
      if (!Number.isInteger(idx) || idx < 0 || idx >= state.channel_draft.broadcast_presets.length) return;
      state.channel_draft.broadcast_presets.splice(idx, 1);
      if (!state.channel_draft.broadcast_presets.length) {
        state.channel_draft.broadcast_presets.push({ name: "Preset 1", text: "" });
      }
      renderBroadcastPresets();
    });

    document.getElementById("broadcastPresetList").addEventListener("change", () => {
      persistChannelDraft();
    });
    document.getElementById("discussionGroupIdInput").addEventListener("change", () => {
      persistChannelDraft();
    });
    document.getElementById("commentsOnPostsEnabled").addEventListener("change", () => {
      persistChannelDraft();
    });

    document.getElementById("submitSetting").addEventListener("click", () => {
      const select = document.getElementById("targetSelect");
      const status = document.getElementById("settingsStatus");
      if (!select.value) {
        setStatus(status, "Tiada target dipilih.", false);
        return;
      }

      const targetId = Number(select.value);
      if (!Number.isSafeInteger(targetId)) {
        setStatus(status, "Target ID tak sah.", false);
        return;
      }

      if (settingsTab === "group") {
        persistProfileDraft();
        ensureGroupProfiles();
        const enabled = state.group_profile_draft.enabled_profile_ids;
        if (!enabled.length) {
          setStatus(status, "Pilih sekurang-kurangnya 1 profile aktif.", false);
          return;
        }

        const payload = {
          type: "reezo_moderator_target_settings_save",
          target_type: "group",
          target_id: targetId,
          group_profiles: state.group_profile_draft.profiles,
          enabled_profile_ids: enabled
        };

        state.target_settings[String(targetId)] = {
          ...(state.target_settings[String(targetId)] || {}),
          group_profiles: state.group_profile_draft.profiles,
          enabled_profile_ids: enabled
        };

        sendPayload(payload);
        setStatus(status, "Setting group submitted.\n" + document.getElementById("groupSummary").textContent, true);
        return;
      }

      persistChannelDraft();
      const discussionGroupRaw = state.channel_draft.discussion_group_id;
      let discussionGroupId = null;
      if (discussionGroupRaw) {
        if (!/^\-\d+$/.test(discussionGroupRaw)) {
          setStatus(status, "Discussion group id mesti nombor negatif.", false);
          return;
        }
        discussionGroupId = Number(discussionGroupRaw);
      }
      const presets = state.channel_draft.broadcast_presets.filter((x) => x && x.name && x.text);

      state.target_settings[String(targetId)] = {
        ...(state.target_settings[String(targetId)] || {}),
        discussion_group_id: discussionGroupId,
        comments_on_posts_enabled: state.channel_draft.comments_on_posts_enabled,
        broadcast_presets: presets
      };

      sendPayload({
        type: "reezo_moderator_target_settings_save",
        target_type: "channel",
        target_id: targetId,
        discussion_group_id: discussionGroupId,
        comments_on_posts_enabled: state.channel_draft.comments_on_posts_enabled,
        broadcast_presets: presets
      });
      setStatus(status, "Channel setting submitted.\nDiscussion group: " + (discussionGroupId !== null ? discussionGroupId : "(not set)") + "\nComment on post: " + (state.channel_draft.comments_on_posts_enabled ? "on" : "off") + "\nPresets: " + presets.length, true);
    });

    typeButtonStyle();
    tabButtonStyle();
    if (!["menu", "add", "settings"].includes(view)) view = "menu";
    switchView(view);
  </script>
</body>
</html>
